---
output:
  github_document:
    pandoc_args: [
      "--columns", "2000"
    ]
    toc: true
---
 
<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
options(max.print = 50)
dir.create("readmeTemp")
```

# r-geno-tools-engine

<!-- badges: start -->
<!-- badges: end -->

The goal of "r-geno-tools-engine" is to provide a simple "input/output" style command line toolbox for several genomic related analysis in order to be used inside an API or other services.



# Build r-geno-tools-engine

The easiest way to use r-geno-tools-engine is to use the [Docker](https://www.docker.com/) image. To build the docker image simply do:

```sh
git clone https://github.com/ut-biomet/r-geno-tools-engine
cd r-geno-tools-engine
docker build -t rgenotoolsengine ./
```

## Test the image

You can test the image by running:

```sh
docker run --rm --entrypoint="Rscript" rgenotoolsengine ./tests/testthat.R
```

All tests should pass.


# How to use r-geno-tools-engine 

## from Docker

Basically the command to use the engine from the docker image is as follow:

```sh
docker run --rm rgenotoolsengine <subcommand> --param1 valueOfParam1 --param2 valueOfParam2 ...
```

The sub-command can be one of: (see: `docker run --rm rgenotoolsengine --help`)

- `gwas`: to do a gwas analysis from geno and pheno files
- `gwas-manplot`: to create an interactive or static manhathan plot from the results generated by `gwas`
- `gwas-adjresults`: to calculate the adjusted p-value from the results generated by `gwas`
- `ldplot`: to get a plot showing the Linkage disequilibrium between consecutive markers.
- `relmat-ped`: to calculate the relationship matrix from a pedigree file.
- `relmat-heatmap`: to get the heatmap of a relationship matrix.
- `pedNetwork`: to get an interactive pedigree network from a pedigree file.

The parameters to use depends of the sub-command. You can have an exhaustive list of them
by using:

```sh
docker run --rm rgenotoolsengine <subcommand> --help
```

However, the tools need to read/write files from the host machine.
To let docker container access those files, you need to mount the the folders
containing the files in the container using the option `-v --volume`.
Then the file path must be specify relative to the place in the container.
(See examples below).

```sh
docker run --rm \
    -v /path/to/folder1/on/host/:/dockerFolder1 \
    -v /path/to/folder2/on/host/:/dockerFolder2 \
    <subcommand> \
    --fileParam1 "/dockerFolder1/nameOfFile1.txt" \
    --fileParam2 "/dockerFolder2/nameOfFile2.txt" \
    --param3 ...
```


## Without Docker (need R installed)

This r-geno-tools-engine is written in `R`, therefore it can also be run
directly from your computer (without docker) if you have `R` and the all the
dependencies packages installed.

### Install dependencies

To install r-geno-tools-engine's packages dependencies, first install the [`renv`](https://rstudio.github.io/renv/articles/renv.html) package.
Then this package will install automatically the dependencies:

In an `R` console:

```R
# open the repo as an Rstudio project
# or use `setwd('path/to/r-geno-tools-engine)`

# Install `renv`
install.packages(renv)

# Install dependencies
renv::restore()
```


### usage

To use the engine from `R` you can execute the `R-geno-tools-Engine.R` file with the `Rscript` command.

From a bash terminal

```sh
Rscript ./r-geno-tools-engine.R <subcommand> --param1 valueOfParam1 --param2 valueOfParam2 ...
```

See: 

```
Rscript ./r-geno-tools-engine.R --help
```

and 

```
Rscript ./r-geno-tools-engine.R <subcommand> --help
```


## As an R library

It is also possible to use this engine in other project written in `R` as a
library. For that I suggest to include this repository as a git sub-module of
your project.

Then you can load in your code the engine's function using:

```r
invisible(
  sapply(FUN = source,
         X = list.files("path/to/r-geno-tools-engine/src", pattern = ".R$",full.names = T))
)
```

For each tool of the engine, some "main functions" are available. Those
functions do essentially the same than the command lines ones. It is recommended
to use those functions in your R project.

Other "utility" functions are also available (eg. for loading data, save the results...) see the [functions documentation](./doc/README.md) for an exhaustive list.



# Functions documentation

All the R functions of this engine are documented in [`./doc/README.md`](doc/README.md).

You can generate this markdown documentation using the function `writeDoc` (defined in [`./src/utils.R`](src/utils.R)):

```{r eval=FALSE}
writeDoc(srcDir = "src",
         docDir = "doc")
```


# Tests

The R package `testthat` is needed to run the unit tests.
To run the unit tests of this engine you can use the command:

```sh
Rscript ./tests/testthat.R
```




# Tools

## GWAS

<details><summary>Click to expand</summary>

### Introduction

This toolbox provide several genomic analysis. To get a simple description of each of them, please

GWAS stands for [Genome-Wide Association Study](https://en.wikipedia.org/wiki/Genome-wide_association_study). It is a statistical study that aims to detect genetic markers associated with a particular phenotypic trait.

To test if a marker is associated with a particular phenotypic trait, we split individuals into different groups according to their genotype for the studied marker and we test if there is a statistical difference between the phenotypic values of the groups. The strength of the statistical difference is measured by what statisticians call the "[p-value](https://en.wikipedia.org/wiki/P-value)".

Usually to consider a test "statistically significant" we check if the p-value of the test is lower than a threshold "α". In this case the test is considered positive (*"there is a statistical difference"*) but we have a probability α to have a false positive. Very often α is equal to 5% or 1%.

GWAS analysis does this test individually and independently for all the genetic markers in the data-set and records the "statistical significance" (the p-values) of all the tests.

However, the number of tested genetic markers are usually very large (several hundreds of thousands or several million) therefore, the number of false-positive can be high even for a small value of α. For example, with α=1%, 500000 markers, and if none of them is associated with the phenotypic trait, we can still expect 5000 "significant test".

To avoid that, the p-values must be [adjusted](https://en.wikipedia.org/wiki/Multiple_comparisons_problem) according to the number of markers.

Finally, the result of a GWAS analysis is presented as a [Manhattan_plot](https://en.wikipedia.org/wiki/Manhattan_plot) which shows the `-log(p-value)` on the y-axis and all the markers (order according to their position on the chromosomes) on the x-axis. A horizontal line represents the significance threshold and the points of the markers above the line can be considered as being associated with the phenotypic trait.

![screenshot of the plotly graph](README_files/manPlot.png)


r-geno-tools-engine provides command line tools to do GWAS analysis.

> Note: You can also check this [7min video](https://www.youtube.com/watch?v=sOP8WacfBM8) by Nuno Carvalho that explain GWAS very well. 



### Functions


#### `gwas`

To do a gwas analysis and write the results in a json file.

```sh
docker run --rm -v "$PWD"/data/geno/:/geno \
    -v "$PWD"/data/pheno/:/pheno \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    gwas \
    --genoFile "/geno/testMarkerData01.vcf.gz" \
    --phenoFile "/pheno/testPhenoData01.csv" \
    --trait "Flowering.time.at.Arkansas" \
    --test "score" \
    --fixed 0 \
    --response "quantitative" \
    --thresh_maf 0.05 \
    --thresh_callrate 0.95 \
    --outFile "/out/gwasRes.json"
```

#### `gwas-manplot`

To create a Manhattan plot.

**Interactive plot:**

```sh
docker run --rm -v "$PWD"/readmeTemp:/files rgenotoolsengine \
    gwas-manplot \
    --gwasFile "/files/gwasRes.json" \
    --adj_method "bonferroni" \
    --thresh_p 0.05 \
    --interactive TRUE \
    --filter_nPoints 3000 \
    --outFile "/files/manPlot.html"
```

**Static plot:**

```sh
docker run --rm -v "$PWD"/readmeTemp:/files rgenotoolsengine \
    gwas-manplot \
    --gwasFile "/files/gwasRes.json" \
    --adj_method "bonferroni" \
    --thresh_p 0.05 \
    --interactive FALSE \
    --outFile "/files/manPlot.png"
```



#### `adjresults`

To create a `json` file with the gwas results with adjusted p-values.
It is also possible to filter the result to keep the values with the lowest
p-values.

```sh
docker run --rm -v "$PWD"/readmeTemp:/files rgenotoolsengine \
    gwas-adjResults \
    --gwasFile "/files/gwasRes.json" \
    --adj_method "bonferroni" \
    --filter_nPoints 3000 \
    --outFile "/files/adjRes.json"
```


### Main R functions

For a usage as R library one can use those functions.

```{r include=FALSE}
invisible(
  sapply(FUN = source,
         X = list.files("src", pattern = ".R$",full.names = T))
)
```


```{r runGWAS}
gwas_results <- run_gwas(genoFile = "data/geno/testMarkerData01.vcf.gz",
                         phenoFile = "data/pheno/testPhenoData01.csv",
                         genoUrl = NULL,
                         phenoUrl = NULL,
                         trait = "Flowering.time.at.Arkansas",
                         test = "score",
                         fixed = 0,
                         response = "quantitative",
                         thresh_maf = 0.05,
                         thresh_callrate = 0.95,
                         outFile = tempfile(fileext = ".json"))
gwas_results$file
substr(gwas_results$gwasRes, start=1, stop=500)
```

```{r draw_manhattanPlot}
p <- draw_manhattanPlot(gwasFile = gwas_results$file,
                        gwasUrl = NULL,
                        adj_method = "bonferroni",
                        thresh_p = 0.05,
                        chr = NA,
                        interactive = TRUE,
                        # filter_pAdj = 1,
                        # filter_nPoints = Inf,
                        filter_quant = 0.1,
                        outFile = tempfile(fileext = ".html"))
```

```{r adj_pvals}
gwas_adj <- run_resAdjustment(gwasFile = gwas_results$file,
                              gwasUrl = NULL,
                              adj_method = "bonferroni",
                              outFile = tempfile(fileext = ".json"))
substr(gwas_adj$gwasAdjusted, start=1, stop=500)
```

</details>




## LD plot

<details><summary>Click to expand</summary>

This help to calculate and visualize the linkage disequilibrium between some
consecutive snps.


```sh
docker run --rm -v "$PWD"/data/geno/:/geno \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    ldplot \
    --genoFile "/geno/testMarkerData01.vcf.gz" \
    --from 42 \
    --to 62 \
    --outFile "/out/ldplot.png"
```

**Main function**

```{r draw_ldPlot}
imgFile <- draw_ldPlot(genoFile = "data/geno/testMarkerData01.vcf.gz",
                       genoUrl = NULL,
                       from = 42,
                       to = 62,
                       outFile = tempfile(fileext = ".png")) 
```

</details>



## Relationship matrix

<details><summary>Click to expand</summary>

Relationship matrix represents how close two individuals are to each other (share the same genes). It can be calculated using their pedigree, or their genotypes.


### Pedigree relationship matrix

This engine can calculate the pedigree-based relationship matrix:

```sh
docker run --rm -v "$PWD"/data/pedigree/:/pedigree \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    relmat-ped \
    --pedFile "/pedigree/testPedData_char.csv" \
    --outFile "/out/pedRelMat.json"
```

```{r pedRelMat}
calc_pedRelMAt(pedFile = 'data/pedigree/testPedData_char.csv',
               pedUrl = NULL,
               header = TRUE,
               unknown_string = '',
               outFile = tempfile(fileext = ".json"))
```



### Genomic relationship matrix

This engine can calculate the genomic-based relationship matrix:

```sh
docker run --rm -v "$PWD"/data/geno/:/geno \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    relmat-geno \
    --genoFile "/geno/breedGame_geno.vcf.gz" \
    --outFile "/out/genoRelMat.json"
```


```{r genoRelMat}
calc_genoRelMAt(genoFile = 'data/geno/breedGame_geno.vcf.gz',
                genoUrl = NULL,
                outFile = tempfile(fileext = ".json"))
```


### Combined relationship matrix

This method allow to correct a pedigree relationship matrix using a genomic 
relationship matrix.

2 methods are implemented:

- `Legarra`: *Legarra, A, et al. 2009 A relationship matrix including full pedigree and genomic information. Journal of Dairy Science 92, 4656–4663*
- `Martini`: *Martini, JW, et al. 2018 The effect of the H-1 scaling factors tau and omega on the structure of H in the single-step procedure. Genetics Selection Evolution 50(1), 16*. This method use additional parameters `tau` and `omega`. Martini's 
method with `tau=1` and `omega=1` is equivalent to the `Legarra`'s method.

```sh
docker run --rm -v "$PWD"/data/results/:/results \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    relmat-combined \
    --ped-relmatFile /results/breedGame_pedRelMat.csv
    --geno-relmatFile /results/breedGame_genoRelMat.csv
    --combine-method Martini
    --tau 1
    --omega 0.5
    --outFile "/out/combined_relMat.json"
```


```{r combinedRelMat}
calc_combinedRelMat(pedRelMatFile = 'data/results/breedGame_pedRelMat.csv',
                    genoRelMatFile = 'data/results/breedGame_genoRelMat.csv',
                    method = "Martini",
                    tau = 1,
                    omega = 0.5,
                    outFile = tempfile(fileext = ".json"))
```




### Relationship matrix visualisation

The engine include a function to generate an heatmap of a relationship matrix:

This heatmap can either be interactive (`.html` file) or static (`.png` file).

![heatmap](./data/results/relationshipHeatmap.png)

```sh
docker run --rm -v "$PWD"/data/results/:/results \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    relmat-heatmap \
    --relmatFile "/results/pedRelMat.json" \
    --outFile "/out/relMat_heatmap.png"
```

```{r relMat-heatmap}
draw_relHeatmap(relMatFile = 'data/results/pedigreeRelationship.csv',
                relMatUrl = NULL,
                interactive = FALSE,
                outFile = tempfile(fileext = ".png"))
```

</details>

## Pedigree network

<details><summary>Click to expand</summary>

**_This is quite experimental_**

The engine contain a function to generate an interactive network of the pedigree relations.

Individuals with parental relations are linked with an arrow pointing from the parents to the offspring.

![pedNet](README_files/pedNet.png)

> Note: This network is not organized by generation (like a genealogical tree) can be big, messy and not very responsive if the number of individual in the pedigree is big.


```sh
docker run --rm -v "$PWD"/data/pedigree/:/pedigree \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    pedNetwork \
    --pedFile "/pedigree/testPedData_char.csv" \
    --outFile "/out/pedNet.html"
```

**Main function**

```{r draw_pedNet}
imgFile <- draw_pedNetwork(pedFile = "data/pedigree/testPedData_char.csv",
                           pedUrl = NULL,
                           unknown_string = '',
                           header = TRUE,
                           outFile = tempfile(fileext = ".html")) 
```


</details>



## Crossing Simulation

<details><summary>Click to expand</summary>

### Introduction

<details><summary>Click to see <strong>GitHub</strong> version</summary>
This engine contain a simulation tool that can simulate the genotypes of
some progeny given the phased genotypes of parental individuals. 

The for the simulation, the engine needs:

- The phased genotypes of the parents
- A crossing table specifying which cross to simulate
- The SNP coordinates in base pair and in Morgan
- The chromosomes lengths in base pair and in Morgan


To generate the SNP genotypes of new individuals from those of the parents,
the engine simulate two gametogenesis, one from each parent:

For each pair of chromosome:

We drew the number of crossing-overs \$n_{co}\$ for each chromosome in a 
Poisson distribution of rate \$l_{chr}\$, which is the length of the chromosome 
in Morgan:

\$\$
n_{co} \\sim \\text{Pois}(l_{chr})
\$\$


When \$n_{co} \\neq 0 \$, we drew independently the positions of crossing-overs
in a uniform distribution along the length of the chromosome in Morgan.
We had, the sampled positions \$pos_i\$ \n
(\$\\forall i \\in [0,n_{co}+1 ] \$)
of the crossing-overs so
that \$pos_j < pos_{j+1}\$ (\$\\forall j \\in [0,n_{co}]\$) 
with \$pos_0 = 0\$ and \$pos_{n_{co}+1} = l_{chr}\$.


\$X\$ was the \$2\\times n_{snp_k}\$ matrix representing the genotype of the
parent for the current pair of chromosomes \$k\$. Each individual represents one
chromosome of the pair. \$Y\$ was the vector of length \${n_{snp}}_k\$ representing 
the genotype of the gamete for the chromosome pair. We set \$[a,b] = [1, 2]\$ 
or \$[2, 1]\$ with probability \$\\frac{1}{2}\$. \$Y\$ was then calculated as:

$$
Y[i] = \left\{
\begin{array}{ll}
X[a,i] & \text{if} \quad \exists\ k \in [0, floor\left(\frac{n_{co}}{2}\right)],  pos_{2k} \leq pos_i < pos_{2k+1} \\
X[b,i] & \text{if} \quad \exists\ k \in [1, floor\left(\frac{n_{co}}{2}\right)],  pos_{2k-1} < pos_i \leq pos_{2k}
\end{array}
\right.
$$

where \$pos_i\$ is the position of the marker \$i\$.

Genotype of the offspring is obtain by merging two gametes from its parents.

</details>

<details><summary>Click to see <strong>GitLab</strong> version</summary>

This engine contain a simulation tool that can simulate the genotypes of
some progeny given the phased genotypes of parental individuals. 

The for the simulation, the engine needs:

- The phased genotypes of the parents
- A crossing table specifying which cross to simulate
- The SNP coordinates in base pair and in Morgan
- The chromosomes lengths in base pair and in Morgan


To generate the SNP genotypes of new individuals from those of the parents,
the engine simulate two gametogenesis, one from each parent:

For each pair of chromosome:

- We drew the number of crossing-overs \$`n_{co}`\$ for each chromosome in a 
Poisson distribution of rate \$`l_{chr}`\$, which is the length of the chromosome 
in Morgan: \$`n_{co} \sim \text{Pois}(l_{chr})`\$
- When \$`n_{co} \neq 0 `\$, we drew independently the positions of crossing-overs
in a uniform distribution along the length of the chromosome in Morgan.
We had, the sampled positions \$`pos_i`\$
(\$`\forall i \in \llbracket 0,n_{co}+1 \rrbracket `\$) of the crossing-overs so
that \$`pos_j < pos_{j+1}`\$ (\$`\forall j \in \llbracket0,n_{co}\rrbracket`\$) 
with \$`pos_0 = 0`\$ and \$`pos_{n_{co}+1} = l_{chr}`\$.
- \$`X`\$ was the \$`2 \times {n_{snp}}_k`\$ matrix representing the genotype of the
parent for the current pair of chromosomes \$`k`\$. Each individual represents one
chromosome of the pair. \$Y\$ was the vector of length \$`{n_{snp}}_k`\$ representing 
the genotype of the gamete for the chromosome pair. We set \$`[a,b] = [1, 2]`\$ 
or \$`[2, 1]`\$ with probability \$`\frac{1}{2}`\$. \$`Y`\$ was then calculated as:

```math
Y[i] = \left\{
\begin{array}{ll}
X[a,i] & \text{if} \quad \exists\ k \in [0, floor\left(\frac{n_{co}}{2}\right)],  pos_{2k} \leq pos_i < pos_{2k+1} \\
X[b,i] & \text{if} \quad \exists\ k \in [1, floor\left(\frac{n_{co}}{2}\right)],  pos_{2k-1} < pos_i \leq pos_{2k}
\end{array}
\right.
```

where \$`pos_i`\$ is the position of the marker \$`i`\$.

Genotype of the offspring is obtain by merging two gametes from its parents.

</details>


### Command


```sh
docker run --rm -v "$PWD"/data/:/data \
    -v "$PWD"/readmeTemp:/out rgenotoolsengine \
    crossing-simulation \
    --genoFile "/data/geno/breedGame_phasedGeno.vcf.gz" \
    --crossTableFile "/data/crossingTable/breedGame_crossTable.csv" \
    --SNPcoordFile "/data/SNPcoordinates/breedingGame_SNPcoord.csv" \
    --chrInfoFile "/data/chromosomesInformation/breedingGame_chrInfo.csv" \
    --nCross 10 \
    --outFile "/out/crossSim.vcf.gz"
```

**Main function**

```{r crossing-sim}
crossingSimulation(genoFile = 'data/geno/breedGame_phasedGeno.vcf.gz',
                   crossTableFile = 'data/crossingTable/breedGame_crossTable.csv',
                   SNPcoordFile = 'data/SNPcoordinates/breedingGame_SNPcoord.csv',
                   chrInfoFile = 'data/chromosomesInformation/breedingGame_chrInfo.csv',
                   nCross = 10,
                   outFile = tempfile(fileext = ".vcf.gz"))
```

</details>





# Data references

Some example data are available in the folder [data](data/). This folder also includes examples of output files.

These examples output files can be automatically generated using the function `createResultExample` (defined in [`./src/utils.R`](src/utils.R)):

```{r eval=FALSE}
createResultExample()
```

The genotypic and phenotypic data used as example come from:

> Keyan Zhao, Chih-Wei Tung, Georgia C. Eizenga, Mark H. Wright, M. Liakat Ali, Adam H. Price, Gareth J. Norton, M. Rafiqul Islam, Andy Reynolds, Jason Mezey, Anna M. McClung, Carlos D. Bustamante & Susan R. McCouch (2011). [Genome-wide association mapping reveals a rich genetic architecture of complex traits in *Oryza sativa*.](http://www.nature.com/ncomms/journal/v2/n9/full/ncomms1467.html) Nat Comm 2:467 | DOI: 10.1038/ncomms1467, Published Online 13 Sep 2011.

> Flutre, T., Diot, J., and David, J. (2019). [PlantBreedGame: A Serious Game that Puts Students in the Breeder’s Seat. Crop Science.](https://acsess.onlinelibrary.wiley.com/doi/10.2135/cropsci2019.03.0183le) DOI 10.2135/cropsci2019.03.0183le


# Utils

The [`utils`](./utils) folder contain miscellaneous code that can be useful for developers working on this project. This engine should NOT depend on any file of this folder.

```{r, include = FALSE}
# remove temp dir
unlink("readmeTemp", recursive = TRUE)
```
